<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatSphere</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="chat-container">
    <div class="header">
      <span id="currentUsername">@username</span>
      <span id="sidebarToggle">‚ãÆ</span>
    </div>
    <div class="messages" id="messages"></div>
    <div class="error-message" id="errorMessage"></div>
    <div class="input-area">
      <div class="mention-suggestions" id="mentionSuggestions"></div>
      <input type="text" id="messageInput" placeholder="Type a message... (use @ for mentions)" />
      <button id="sendButton">Send</button>
    </div>
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="close-btn" id="closeSidebar">‚úñ</div>
        <div class="back-btn" id="backSidebar">‚Üê Back</div>
        <h2>‚öôÔ∏è Settings</h2>
      </div>
      <div class="sidebar-section">
        <h3>üë§ My Profile</h3>
        <div class="profile-view">
          <img id="currentProfileImage" src="img/1.jpg" alt="Profile" onerror="this.src='https://via.placeholder.com/48'">
          <div>
            <strong id="currentProfileUsername">@You</strong>
            <p id="currentProfileStatus">Online</p>
          </div>
        </div>
        <label>Username</label>
        <input type="text" id="usernameInput" placeholder="Enter name">
        <label>Status</label>
        <input type="text" id="statusInput" placeholder="Enter status">
        <label>Profile Image</label>
        <div id="imagePicker" class="image-picker"></div>
      </div>
      <hr>
      <div class="sidebar-section">
        <h3>üé® Theme</h3>
        <select id="themeSelect">
          <option value="red">Red + Orange</option>
          <option value="blue">White + Blue</option>
          <option value="green">Green + Yellow</option>
          <option value="dark">Dark Mode</option>
          <option value="glassmorphism">Glassmorphism</option>
          <option value="neumorphism">Neumorphism</option>
        </select>
        <div class="theme-customizer">
          <label>Custom Gradient</label>
          <input type="color" id="color1" value="#ff9966" />
          <input type="color" id="color2" value="#ff5e62" />
          <button id="applyCustomTheme">Apply Custom</button>
        </div>
      </div>
      <hr>
      <div class="sidebar-section">
        <h3>üìä Activity</h3>
        <p>üü¢ Active: <span id="activeUser">@you</span></p>
        <p>üïí Last Seen: <span id="lastActive">Just now</span></p>
        <p>üë• Active Users: <span id="activeUsersCount">0</span></p>
        <p>üåê Total Users: <span id="totalUsers">0</span></p>
      </div>
    </div>
    <div class="profile-modal" id="profileModal">
      <div class="profile-modal-content">
        <span class="close-modal" id="closeModal">‚úñ</span>
        <img id="modalProfileImage" src="https://via.placeholder.com/48" alt="Profile">
        <h3 id="modalUsername">@username</h3>
        <p id="modalStatus">Online</p>
        <p id="modalLastActive">Last Active: Just now</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDt3SGnGYHxZxUNHaZpLz6uOQ9L5oDSLzM",
      authDomain: "chatting-8dbc3.firebaseapp.com",
      projectId: "chatting-8dbc3",
      storageBucket: "chatting-8dbc3.firebasestorage.app",
      messagingSenderId: "126011339663",
      appId: "1:126011339663:web:6a23fc281361d86e29d1fa",
      measurementId: "G-V61SB8Q411"
    };

    let db, messagesRef, usersRef;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      messagesRef = collection(db, "messages");
      usersRef = collection(db, "users");
    } catch (error) {
      console.error("Error initializing Firebase:", error);
      showError("Failed to connect to database. Check configuration.");
    }

    let username = localStorage.getItem("username") || "You";
    let userStatus = localStorage.getItem("status") || "Online";
    let selectedProfileImage = localStorage.getItem("profileImage") || 1;
    let userId = localStorage.getItem("userId") || Date.now().toString();
    let usersList = [];

    const currentUsername = document.getElementById("currentUsername");
    const activeUser = document.getElementById("activeUser");
    const statusInput = document.getElementById("statusInput");
    const messagesDiv = document.getElementById("messages");
    const errorMessage = document.getElementById("errorMessage");
    const mentionSuggestions = document.getElementById("mentionSuggestions");
    const currentProfileImage = document.getElementById("currentProfileImage");
    const currentProfileUsername = document.getElementById("currentProfileUsername");
    const currentProfileStatus = document.getElementById("currentProfileStatus");
    const profileModal = document.getElementById("profileModal");
    const modalProfileImage = document.getElementById("modalProfileImage");
    const modalUsername = document.getElementById("modalUsername");
    const modalStatus = document.getElementById("modalStatus");
    const modalLastActive = document.getElementById("modalLastActive");

    currentUsername.textContent = `@${username}`;
    activeUser.textContent = `@${username}`;
    statusInput.value = userStatus;
    currentProfileUsername.textContent = `@${username}`;
    currentProfileStatus.textContent = userStatus;
    currentProfileImage.src = `img/${selectedProfileImage}.jpg`;

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = "block";
      setTimeout(() => errorMessage.style.display = "none", 5000);
    }

    window.toggleSidebar = function () {
      document.getElementById("sidebar").classList.toggle("active");
      profileModal.classList.remove("active");
    };

    window.showProfile = function (username) {
      const user = usersList.find(u => u.username === username);
      if (user) {
        modalUsername.textContent = `@${user.username}`;
        modalStatus.textContent = user.status || "Online";
        modalProfileImage.src = `img/${user.profileImage}.jpg`;
        modalProfileImage.onerror = () => { modalProfileImage.src = 'https://via.placeholder.com/48'; };
        modalLastActive.textContent = `Last Active: ${user.lastActive ? new Date(user.lastActive.toDate()).toLocaleString() : "Unknown"}`;
        profileModal.classList.add("active");
      } else {
        showError("User profile not found.");
      }
    };

    window.sendMessage = async function () {
      const messageInput = document.getElementById("messageInput");
      const text = messageInput.value.trim();
      if (!text || !db) return;

      try {
        await addDoc(messagesRef, {
          text,
          username,
          profileImage: selectedProfileImage,
          timestamp: serverTimestamp(),
          userId,
        });
        messageInput.value = "";
        mentionSuggestions.style.display = "none";
        updateUserProfile();
      } catch (error) {
        console.error("Error sending message:", error);
        showError("Failed to send message. Check permissions or connection.");
      }
    };

    window.applyTheme = function (theme) {
      document.body.classList.remove("neumorphism");
      let bg = '';
      switch (theme) {
        case 'red': bg = 'linear-gradient(135deg, #ff9966, #ff5e62)'; break;
        case 'blue': bg = 'linear-gradient(135deg, #ffffff, #00bcd4)'; break;
        case 'green': bg = 'linear-gradient(135deg, #a8e063, #56ab2f)'; break;
        case 'dark': bg = 'linear-gradient(135deg, #1f1c2c, #000000)'; break;
        case 'glassmorphism': bg = 'linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.3))'; break;
        case 'neumorphism':
          bg = 'linear-gradient(135deg, #e0e0e0, #f5f5f5)';
          document.body.classList.add("neumorphism");
          break;
      }
      document.body.style.background = bg;
    };

    window.applyCustomTheme = function () {
      document.body.classList.remove("neumorphism");
      const color1 = document.getElementById("color1").value;
      const color2 = document.getElementById("color2").value;
      document.body.style.background = `linear-gradient(135deg, ${color1}, ${color2})`;
    };

    window.editMessage = async function (docId, oldText) {
      if (!db) return;
      const newText = prompt("Edit your message:", oldText);
      if (newText) {
        try {
          await updateDoc(doc(db, "messages", docId), { text: newText });
        } catch (error) {
          console.error("Error editing message:", error);
          showError("Failed to edit message. Check permissions.");
        }
      }
    };

    window.deleteMessage = async function (docId) {
      if (!db) return;
      if (confirm("Delete this message?")) {
        try {
          await deleteDoc(doc(db, "messages", docId));
        } catch (error) {
          console.error("Error deleting message:", error);
          showError("Failed to delete message. Check permissions.");
        }
      }
    };

    window.reactMessage = function (docId, reaction) {
      console.log(`Reacted with ${reaction} to message ${docId}`);
      showError("Reactions not fully implemented yet.");
    };

    async function updateUserProfile() {
      if (!db) return;
      try {
        await addDoc(usersRef, {
          userId,
          username,
          status: userStatus,
          profileImage: selectedProfileImage,
          lastActive: serverTimestamp(),
        });
        document.getElementById("lastActive").textContent = "Just now";
      } catch (error) {
        console.error("Error updating user profile:", error);
        showError("Failed to update profile. Check permissions.");
      }
    }

    function loadImagePicker() {
      const picker = document.getElementById("imagePicker");
      for (let i = 1; i <= 25; i++) {
        const img = document.createElement("img");
        img.src = `img/${i}.jpg`;
        img.alt = `Profile ${i}`;
        img.onerror = () => { img.src = 'https://via.placeholder.com/36'; };
        img.onclick = () => selectProfileImage(i, img);
        if (i == selectedProfileImage) img.style.border = "2px solid white";
        picker.appendChild(img);
      }
    }

    function selectProfileImage(id, img) {
      selectedProfileImage = id;
      localStorage.setItem("profileImage", id);
      document.querySelectorAll("#imagePicker img").forEach(i => i.style.border = "none");
      img.style.border = "2px solid white";
      currentProfileImage.src = `img/${id}.jpg`;
      updateUserProfile();
    }

    function formatMessage(text) {
      return text
        .replace(/@(\w+)/g, '<span class="mention" onclick="showProfile(\'$1\')">@$1</span>')
        .replace(/#(\w+)/g, '<span class="hashtag">#$1</span>');
    }

    function showMentionSuggestions(input) {
      const match = input.match(/@(\w*)$/);
      if (match) {
        const query = match[1].toLowerCase();
        const filteredUsers = usersList.filter(user => user.username.toLowerCase().startsWith(query));
        if (filteredUsers.length > 0) {
          mentionSuggestions.innerHTML = filteredUsers.map(user => `
            <div class="suggestion" onclick="selectMention('${user.username}')">@${user.username}</div>
          `).join('');
          mentionSuggestions.style.display = "block";
        } else {
          mentionSuggestions.style.display = "none";
        }
      } else {
        mentionSuggestions.style.display = "none";
      }
    }

    window.selectMention = function (username) {
      const messageInput = document.getElementById("messageInput");
      const text = messageInput.value;
      const lastAt = text.lastIndexOf('@');
      messageInput.value = text.substring(0, lastAt) + `@${username} `;
      mentionSuggestions.style.display = "none";
      messageInput.focus();
    };

    document.getElementById("sidebarToggle").addEventListener("click", toggleSidebar);
    document.getElementById("closeSidebar").addEventListener("click", toggleSidebar);
    document.getElementById("backSidebar").addEventListener("click", toggleSidebar);
    document.getElementById("closeModal").addEventListener("click", () => profileModal.classList.remove("active"));
    document.getElementById("sendButton").addEventListener("click", sendMessage);
    document.getElementById("themeSelect").addEventListener("change", (e) => applyTheme(e.target.value));
    document.getElementById("applyCustomTheme").addEventListener("click", applyCustomTheme);
    document.getElementById("usernameInput").addEventListener("change", () => {
      const name = document.getElementById("usernameInput").value.trim();
      if (name) {
        username = name;
        localStorage.setItem("username", name);
        currentUsername.textContent = `@${name}`;
        activeUser.textContent = `@${name}`;
        currentProfileUsername.textContent = `@${name}`;
        updateUserProfile();
      }
    });
    document.getElementById("statusInput").addEventListener("change", () => {
      userStatus = document.getElementById("statusInput").value.trim() || "Online";
      localStorage.setItem("status", userStatus);
      currentProfileStatus.textContent = userStatus;
      updateUserProfile();
    });
    document.getElementById("messageInput").addEventListener("input", (e) => showMentionSuggestions(e.target.value));

    if (db) {
      const q = query(messagesRef, orderBy("timestamp", "asc"));
      onSnapshot(q, (snapshot) => {
        messagesDiv.innerHTML = "";
        snapshot.forEach((doc) => {
          const data = doc.data();
          const isSent = data.userId === userId;
          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${isSent ? "sent" : "received"}`;
          messageDiv.innerHTML = `
            <img src="img/${data.profileImage}.jpg" alt="Profile" onclick="showProfile('${data.username}')" onerror="this.src='https://via.placeholder.com/36'">
            <strong class="username" onclick="showProfile('${data.username}')">@${data.username}</strong>: ${formatMessage(data.text)}
            <div class="timestamp">${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString() : "Sending..."}</div>
            <div class="message-actions">
              ${isSent ? `<span onclick="editMessage('${doc.id}', '${data.text.replace(/'/g, "\\'")}')">Edit</span>` : ""}
              ${isSent ? `<span onclick="deleteMessage('${doc.id}')">Delete</span>` : ""}
              <span onclick="reactMessage('${doc.id}', 'üëç')">üëç</span>
            </div>
          `;
          messagesDiv.appendChild(messageDiv);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, (error) => {
        console.error("Error in messages snapshot:", error);
        showError("Failed to load messages. Check permissions or connection.");
      });

      onSnapshot(usersRef, (snapshot) => {
        usersList = snapshot.docs.map(doc => doc.data());
        const activeUsers = usersList.filter(doc => {
          const lastActive = doc.lastActive?.toDate();
          return lastActive && (new Date() - lastActive < 5 * 60 * 1000);
        }).length;
        document.getElementById("activeUsersCount").textContent = activeUsers;
        document.getElementById("totalUsers").textContent = usersList.length;
      }, (error) => {
        console.error("Error in users snapshot:", error);
        showError("Failed to load user activity. Check permissions or connection.");
      });
    } else {
      showError("Database not initialized. Check Firebase configuration.");
    }

    setInterval(updateUserProfile, 60000);
    loadImagePicker();
  </script>
</body>
</html>